<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>IMQ Inference Demo</title>
    <style>
      body { font-family: system-ui, sans-serif; max-width: 900px; margin: 40px auto; padding: 0 16px; }
      textarea { width: 100%; height: 120px; }
      pre { white-space: pre-wrap; background: #111; color: #eee; padding: 12px; border-radius: 10px; }
      .row { display: flex; gap: 10px; align-items: center; }
      button { padding: 10px 14px; }
      small { color: #666; }
    </style>
  </head>
  <body>
    <h1>Inference Demo: Llama 3.1 8B Instruct - 4-bit IMQ quantized</h1>
    <p><small>OpenAI-compatible endpoint behind the scenes: <code>/v1/chat/completions</code></small></p>

    <div class="row">
      <label>HF Token <input id="hf_token" type="password" placeholder="hf_..." style="width: 300px;" /></label>
      <label><input type="checkbox" id="stream" checked /> Stream</label>
    </div>

    <textarea id="prompt">Explain in 3-5 sentences: The future of artificial intelligence is...</textarea>
    <div class="row">
      <button onclick="send()">Generate</button>
      <label>max_tokens <input id="max_tokens" type="number" value="256" min="1" max="2048"/></label>
      <label>temperature <input id="temp" type="number" value="0.7" step="0.1" min="0" max="2"/></label>
    </div>

    <h3>Output</h3>
    <pre id="out"></pre>

    <script>
      async function send() {
        const out = document.getElementById("out");
        const stream = document.getElementById("stream").checked;
        
        out.textContent = "Generating...";

        const prompt = document.getElementById("prompt").value;
        const max_tokens = parseInt(document.getElementById("max_tokens").value, 10);
        const temperature = parseFloat(document.getElementById("temp").value);
        const token = document.getElementById("hf_token").value.trim();

        const payload = {
          messages: [{ role: "user", content: prompt }],
          max_tokens,
          temperature,
          stream: stream
        };

        const headers = {
          "Content-Type": "application/json"
        };
        if (token) {
          headers["Authorization"] = "Bearer " + token;
        }

        if (stream) {
          // Streaming response
          const res = await fetch("/v1/chat/completions", {
            method: "POST",
            headers: headers,
            body: JSON.stringify(payload)
          });

          if (!res.ok) {
            const error = await res.json();
            out.textContent = JSON.stringify(error, null, 2);
            return;
          }

          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let buffer = "";
          let fullText = "";

          out.textContent = "";

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split("\n");
            buffer = lines.pop(); // Keep incomplete line in buffer

            for (const line of lines) {
              if (line.startsWith("data: ")) {
                const data = line.slice(6);
                if (data === "[DONE]") continue;
                
                try {
                  const chunk = JSON.parse(data);
                  const delta = chunk.choices?.[0]?.delta?.content;
                  if (delta) {
                    fullText += delta;
                    out.textContent = fullText;
                  }
                } catch (e) {
                  // Skip invalid JSON
                }
              }
            }
          }
        } else {
          // Non-streaming response
          const res = await fetch("/v1/chat/completions", {
            method: "POST",
            headers: headers,
            body: JSON.stringify(payload)
          });

          const data = await res.json();
          if (!res.ok) {
            out.textContent = JSON.stringify(data, null, 2);
            return;
          }
          const text = data.choices?.[0]?.message?.content;
          const tps  = data.decode_tps;

          out.textContent =
          (text ?? JSON.stringify(data, null, 2)) +
          (tps != null ? `\n\n---\nTokens per second: ${tps}` : "");
        }
      }
    </script>
  </body>
</html>
