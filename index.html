<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>IMQ Inference Demo</title>
    <style>
      body { font-family: system-ui, sans-serif; max-width: 900px; margin: 40px auto; padding: 0 16px; }
      textarea { width: 100%; height: 120px; }
      pre { white-space: pre-wrap; background: #111; color: #eee; padding: 12px; border-radius: 10px; }
      .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
      button { padding: 10px 14px; cursor: pointer; }
      small { color: #666; }
      input[type="number"], input[type="password"], input[type="text"] { padding: 6px 8px; }
      .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin: 14px 0; }
      .status { color: #666; font-size: 12px; }
    </style>
  </head>
  <body>
    <h1>Inference Demo: Llama 3.1 8B Instruct - 4-bit IMQ quantized</h1>
    <p><small>OpenAI-compatible endpoint behind the scenes: <code>/v1/chat/completions</code></small></p>

    <div class="card">
      <div class="row">
        <label>
          HF Token
          <input id="hf_token" type="password" placeholder="hf_..." style="width: 340px;" autocomplete="off" />
        </label>
        <button onclick="saveToken()">Save token</button>
        <button onclick="clearToken()">Clear token</button>
        <span class="status" id="token_status"></span>
      </div>
      <p><small>
        Token is kept only in your browser (<code>localStorage</code>) and sent as an <code>Authorization: Bearer ...</code> header.
        Avoid putting tokens in URLs.
      </small></p>
    </div>

    <textarea id="prompt">Explain in 3-5 sentences: The future of artificial intelligence is...</textarea>

    <div class="row" style="margin-top: 10px;">
      <button onclick="send()">Generate</button>
      <label>max_tokens <input id="max_tokens" type="number" value="256" min="1" max="2048"/></label>
      <label>temperature <input id="temp" type="number" value="0.7" step="0.1" min="0" max="2"/></label>
    </div>

    <h3>Output</h3>
    <pre id="out"></pre>

    <script>
      const TOKEN_LS_KEY = "HF_TOKEN_DEMO";

      function setTokenStatus(msg) {
        document.getElementById("token_status").textContent = msg;
      }

      function loadTokenFromStorage() {
        const saved = localStorage.getItem(TOKEN_LS_KEY);
        if (saved) {
          document.getElementById("hf_token").value = saved;
          setTokenStatus("Token loaded ✅");
        } else {
          setTokenStatus("");
        }
      }

      function saveToken() {
        const token = document.getElementById("hf_token").value.trim();
        if (!token) {
          setTokenStatus("No token to save.");
          return;
        }
        localStorage.setItem(TOKEN_LS_KEY, token);
        setTokenStatus("Token saved ✅");
      }

      function clearToken() {
        localStorage.removeItem(TOKEN_LS_KEY);
        document.getElementById("hf_token").value = "";
        setTokenStatus("Token cleared ✅");
      }

      async function send() {
        const out = document.getElementById("out");
        out.textContent = "Generating...";

        try {
          const prompt = document.getElementById("prompt").value;
          const max_tokens = parseInt(document.getElementById("max_tokens").value, 10);
          const temperature = parseFloat(document.getElementById("temp").value);

          const token = document.getElementById("hf_token").value.trim();
          if (!token) {
            out.textContent = "Missing HF token. Paste it above and click Save token (optional).";
            return;
          }

          const payload = {
            messages: [{ role: "user", content: prompt }],
            max_tokens,
            temperature
          };

          console.log("Sending request:", payload);

          const res = await fetch("/v1/chat/completions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + token
            },
            body: JSON.stringify(payload)
          });

          console.log("Response status:", res.status);

          let data;
          try {
            data = await res.json();
          } catch (e) {
            const raw = await res.text();
            out.textContent = `HTTP ${res.status}\n\n` + raw;
            console.error("Failed to parse JSON:", e);
            return;
          }

          if (!res.ok) {
            out.textContent = `HTTP ${res.status}\n\n` + JSON.stringify(data, null, 2);
            return;
          }

          const text = data.choices?.[0]?.message?.content;
          const tps  = data.decode_tps;

          out.textContent =
            (text ?? JSON.stringify(data, null, 2)) +
            (tps != null ? `\n\n---\nTokens per second: ${tps}` : "");
        } catch (error) {
          console.error("Error:", error);
          out.textContent = `Error: ${error.message}\n\nCheck browser console for details.`;
        }
      }

      // init
      loadTokenFromStorage();
    </script>
  </body>
</html>

